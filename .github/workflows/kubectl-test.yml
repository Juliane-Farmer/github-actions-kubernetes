name: kubectl-test

on:
  workflow_dispatch:

jobs:
  test-kubectl:
    runs-on: self-hosted
    
    env:
      NAMESPACE: demo

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create random pod name
      shell: pwsh
      run: echo "POD_ID=$RANDOM" >> $env:GITHUB_ENV

    - name: Apply pod
      shell: pwsh
      run: |
        (Get-Content k8s/pod.yaml) -replace '\{\{POD_ID\}\}', "$env:POD_ID" |
        kubectl --namespace $env:NAMESPACE apply -f -

    - name: Get pods
      shell: pwsh
      run: kubectl --namespace $env:NAMESPACE get pods
